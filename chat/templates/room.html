{% extends 'base.html' %}

{% block title %} JustChat |
    {% for user in current_room.room_members.all %}
        {% if user.username != request.user.username %}
            {{ user.username }}
        {% endif %}
    {% endfor %}
{% endblock title %}
{% block content %}
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'room.css' %}">

    <section>
        <div class="container px-0">

            <div class="row mx-0">

                


                <div class="col-md-8 px-0 offset-md-1">

                    <div class="card">
                        <div id="cHeader" class="card-header py-2">
                            <h3 class="card-title text-capitalize my-1">
                                {% for user in current_room.room_members.all %}
                                    {% if user.username != request.user.username %}
                                        {{ user.username }}
                                    {% endif %}
                                {% endfor %}
                            </h3>
                        </div>
                        <div id="lol">
                            <div class="card-body py-0 px-md-1" id="chatWindow">
                                {% for message in all_messages %}
                                    <div class="clearfix">
                                        {% if message.sent_by == request.user %}
                                                <p id="senderMsg" class="px-2 py-1 ml-md-5 ml-2 my-1 bg-info rounded">{{ message.message }}</p>
                                        {% else %}
                                                <p id="receiverMsg" class="px-2 py-1 my-1 bg-light rounded">{{ message.message }}</p>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>

                            <div class="card-footer p-0">
                                <div class="input-group">
                                    <input id="chat-message-input" type="text" class="form-control rounded-0" size="50">
                                    <div class="input-group-append">
                                        <input id="chat-message-submit" type="button" value="Send" class="btn btn-info rounded-0 px-3">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </section>

    {{ room_name|json_script:"room-name" }}
    <script>

        var navHeight = document.getElementsByTagName('nav')[0];
        var cTitle = document.getElementById('cHeader');
        var cFooter = document.getElementsByClassName('card-footer')[0];

        var hRemoved = navHeight.offsetHeight + cTitle.offsetHeight + cFooter.offsetHeight;

        var chatWin = document.getElementById('chatWindow');
        chatWin.style.height = window.innerHeight - hRemoved + 'px';
        chatWin.scrollTop = chatWin.scrollHeight;

        window.addEventListener('resize', function(event){
            var newWidth = window.innerWidth;
            var newHeight = window.innerHeight;
        });
        $(window).resize(function() {
            console.log('window was resized');
        });
        window.resize = event => {
            chatWin.style.height = window.innerHeight - hRemoved + 'px';
            chatWin.scrollTop = chatWin.scrollHeight;
        };
        const roomName = JSON.parse(document.getElementById('room-name').textContent);
        const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/chat/'
            + roomName
            + '/'
        );

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);

            var para_div = document.createElement("div");
            para_div.className ="clearfix";

            var para = document.createElement("p");
            if (data.sent_by === '{{ request.user }}'){
                para.setAttribute('id', 'senderMsg');
                para.className = 'bg-info';
            }else{
                para.setAttribute('id', 'receiverMsg');
                para.className = 'bg-light';
            }
            para.classList.add("px-2", "py-1", "my-1", "rounded");

            var node = document.createTextNode(data.message);
            para.appendChild(node);
            para_div.appendChild(para);
            var element = document.getElementById("chatWindow");
            element.appendChild(para_div);

            chatWin.scrollTop = chatWin.scrollHeight;
         };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.keyCode === 13) {  // enter, return
                document.querySelector('#chat-message-submit').click();
            }
        };

        document.querySelector('#chat-message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInputDom.value = '';
        };
    </script>

{% endblock content %}