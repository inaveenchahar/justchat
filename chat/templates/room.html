{% extends 'base.html' %}

{% block title %} JustChat |
    {% for user in current_room.room_members.all %}
        {% if user.username != request.user.username %}
            {{ user.username }}
        {% endif %}
    {% endfor %}
{% endblock title %}
{% block content %}
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'room.css' %}">

    <section>
        <div class="container py-5">

            <div class="row">
                <div class="col-md-8 offset-md-2">

                    <div class="card">
                        <div class="card-header py-2">
                            <h3 class="card-title text-capitalize my-1">
                                {% for user in current_room.room_members.all %}
                                    {% if user.username != request.user.username %}
                                        {{ user.username }}
                                    {% endif %}
                                {% endfor %}
                            </h3>
                        </div>

                        <div class="card-body" id="chatWindow" style="height: 350px; overflow-y: auto">
                            {% for message in all_messages %}
                                <div class="clearfix">
                                    {% if message.sent_by == request.user %}
                                            <p id="senderMsg" class="px-3 py-2 bg-info rounded">{{ message.message }}</p>
                                    {% else %}
                                            <p id="receiverMsg" class="px-3 py-2 bg-light rounded">{{ message.message }}</p>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>

                        <div class="card-footer p-0">
                            <div class="input-group">
                                <input id="chat-message-input" type="text" class="form-control" size="50">
                                <div class="input-group-append">
                                    <input id="chat-message-submit" type="button" value="Send" class="btn btn-primary">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

{#            <textarea class="position-fixed" id="chat-log" cols="100" rows="10" style="overflow-y: scroll"></textarea><br>#}
{#            <div class="input-group fixed-bottom">#}
{#                <input id="chat-message-input" type="text" class="form-control" size="50">#}
{#                <div class="input-group-append">#}
{#                    <input id="chat-message-submit" type="button" value="Send" class="btn btn-primary">#}
{#                </div>#}
{#            </div>#}
        </div>
    </section>

    {{ room_name|json_script:"room-name" }}
    <script>
        var objDiv = document.getElementById("chatWindow");
        objDiv.scrollTop = objDiv.scrollHeight;

        const roomName = JSON.parse(document.getElementById('room-name').textContent);
        const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/chat/'
            + roomName
            + '/'
        );

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);

            var para_div = document.createElement("div");
            para_div.className ="clearfix";

            var para = document.createElement("p");
            if (data.sent_by === '{{ request.user }}'){
                para.setAttribute('id', 'senderMsg');
                para.className = 'bg-info';
            }else{
                para.setAttribute('id', 'receiverMsg');
                para.className = 'bg-light';
            }
            para.classList.add("px-3", "py-2", "rounded");

            var node = document.createTextNode(data.message);
            para.appendChild(node);
            para_div.appendChild(para);
            var element = document.getElementById("chatWindow");
            element.appendChild(para_div);

            var objDiv = document.getElementById("chatWindow");
            objDiv.scrollTop = objDiv.scrollHeight;
            {#document.querySelector('#chat-log').value = (data.message + '-' + data.sent_by + '\n');#}
         };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.keyCode === 13) {  // enter, return
                document.querySelector('#chat-message-submit').click();
            }
        };

        document.querySelector('#chat-message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInputDom.value = '';
        };
    </script>

{% endblock content %}